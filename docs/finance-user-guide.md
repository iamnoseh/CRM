## Дастури фаҳмо: Чӣ гуна модули молиявӣ кор мекунад (CRM Kavsar)

Ин ҳуҷҷат бо забони инсонӣ мефаҳмонад, ки қисмҳои молиявии система чӣ кор мекунанд, чӣ гуна дар якҷоягӣ амал менамоянд ва роҳбар (Manager) ё маъмур (Admin/SuperAdmin) чӣ гуна қадам ба қадам бо онҳо кор мекунад. Барои API-деталҳо ба `docs/finance-api-reference.md` нигаред.

### Нақшҳо ва дастрасӣ
- **Manager**: ба маркази худ дастрасӣ дорад (пардохтҳо, хароҷот, ҳисоботҳо, қарздорон, payroll).
- **Admin/SuperAdmin**: ба ҳама марказҳо дастрасӣ доранд.

---

## 1) Пардохтҳо (Payments) ва квитансияҳо

### Барои чӣ лозим аст?
Пардохт ба қайди маблағи гирифташуда аз донишҷӯ барои моҳ/гурӯҳи муайян хизмат мекунад. Ҳар пардохт дорои:
- нархи аслӣ (аз курси гурӯҳ),
- тахфиф (агар дода шуда бошад),
- маблағи ниҳоӣ (пардохтанӣ),
- тарзи пардохт (нақдӣ/корт/интиқол),
- рақами квитансия (ReceiptNumber) барои чоп/ҳисобдорӣ.

### Чӣ тавр кор мекунад (сенария)
1. Оператор дар саҳифаи гурӯҳ/донишҷӯ «Қабули пардохт»-ро мезанад.
2. Система нархи моҳонаи курси ин гурӯҳро меёбад ва тахфифи эҳтимолиро татбиқ мекунад.
3. Агар донишҷӯ қисман пардохт кунад, оператор **Amount**-ро (масалан 300 аз 500) ворид мекунад; агар ворид накунад, маблағи пурра ҳисоб мешавад. Агар мизоҷ якбора барои 3–4 моҳ пардохт кунад, **MonthsCount**-ро (масалан, 3 ё 4) мегузоред — система барои ҳар моҳ пардохти ҷудо месозад.
4. Оператор тарзи пардохт ва (барои ғайринақдӣ) `transactionId`-ро ворид мекунад.
5. Пас аз «Confirm», система сабти пардохт месозад (бо маблағи пурра ё қисман) ва ба он **ReceiptNumber** нисбат медиҳад (масалан: `CTR-1-202511-000123`).
5. Оператор метавонад квитансияро бинад/боргирӣ кунад ё чоп кунад.

### Чӣ чиз аз худкор меояд?
- Ҳисобкунии тахфиф аз сервиси Discount.
- Тавлиди `ReceiptNumber` ҳангоми эҷод шудан.
- Пардохт танҳо агар ҳолати он `Completed|Paid` бошад, ба даромад дохил мешавад (ҳисоботҳо).

### Чӣ гуна аз фронтенд истифода мешавад?
- Эҷод: `POST /api/payments` бо `studentId, groupId, month, year, paymentMethod, ...`.
- Дидан: `GET /api/payments/{id}`.
- Квитансия: `GET /api/payments/{id}/receipt` — бармегардонад `receiptNumber` ва `downloadUrl` (placeholder барои PDF/HTML).
  - Барои PDF: `GET .../receipt?format=pdf`.


---

## 2) Қарздорон (Debts)

### Барои чӣ лозим аст?
Барои ҳар моҳ/сол донистан, ки кӣ ҳоло ҳам маблағ қарздор аст: нархи моҳона − тахфиф − маблағи пардохташуда = бақия.

### Чӣ тавр кор мекунад (сенария)
1. Менҷер моҳ ва солро интихоб мекунад (масалан, ноябри 2025).
2. Система рӯйхати донишҷӯёнро дар гурӯҳҳои дар маркази ӯ буда мегирад.
3. Барои ҳар донишҷӯ дар ҳар гурӯҳ нархи моҳонарo аз курс мегирад, тахфифро тарҳ мекунад, пардохтҳои воқеӣ барои ҳамин моҳ/солро ҷамъ мекунад.
4. Агар бақия > 0 бошад, шахс дар рӯйхати қарздорон намоиш дода мешавад.

### Чӣ гуна аз фронтенд истифода мешавад?
- `GET /api/finance/centers/{centerId}/debts?year=2025&month=11&studentId=`.
- Баргардонида мешавад рӯйхати `studentName, groupName, originalAmount, discountAmount, paidAmount, balance`.


---

## 3) Хароҷотҳо (Expenses)

### Барои чӣ лозим аст?
Сабти ҳамаи хароҷотҳои марказ: музди меҳнат (salary), иҷора, реклама, таҷҳизот, ва ғайра. Онҳо барои ҳисоб кардани фоида (Net Profit) аз даромад тарҳ мешаванд.

### Чӣ тавр кор мекунад (сенария)
1. Бухгалтер/менҷер ҳангоми пардохти хароҷот (масалан, иҷораи синфхона) «Хароҷот»-ро эҷод мекунад.
2. Категория (мисли `Salary`, `Rent`), сана, маблағ, тарзи пардохт ва тавзеҳро ворид мекунад.
3. Сабт дар ҳисоботҳои молиявӣ ба «хароҷот» дохил мешавад (агар `IsDeleted=false`).

### Чӣ гуна аз фронтенд истифода мешавад?
- Эҷод: `POST /api/expenses`.
- Тағйир: `PUT /api/expenses/{id}`.
- Несткунӣ (soft): `DELETE /api/expenses/{id}`.
- Дидан: `GET /api/expenses/{id}` ва рӯйхат бо фильтр: `GET /api/expenses`.


---

## 4) Ҷамъбастҳои молиявӣ (Summaries)

### Барои чӣ лозим аст?
Барои дидани тасвири умумӣ: даромад, хароҷот, фоида; дар рӯз/моҳ/сол. Ҳамчунин барои графикҳои трендӣ ва тавсиф аз рӯи категорияҳои хароҷот.

### Чӣ тавр кор мекунад (сенария)
1. Менҷер диапазони сана ё моҳ/солро интихоб мекунад.
2. Система пардохтҳои анҷомёфта (Completed/Paid) ва хароҷотҳои боқимондаро барои марказ ҷамъ мекунад.
3. Баробар мекунад: IncomeTotal, ExpenseTotal, NetProfit; инчунин ҷадвали рӯзона ва тавсифи категориявиро месозад.

### Чӣ гуна аз фронтенд истифода мешавад?
- Рӯзона: `GET /api/finance/centers/{centerId}/daily?date=`.
- Моҳона: `GET /api/finance/centers/{centerId}/monthly?year=&month=`.
- Солона: `GET /api/finance/centers/{centerId}/yearly?year=`.
- Давра: `GET /api/finance/centers/{centerId}/summary?start=&end=`.


---

## 5) Payroll барои менторҳо

### Барои чӣ лозим аст?
Ҳар моҳ музди меҳнати менторҳои марказро ҳамчун хароҷоти `Salary` ба таври оммавӣ тавлид мекунад, то ба ҳисоботҳои моҳона дохил шаванд.

### Чӣ тавр кор мекунад (сенария)
1. Менҷер моҳ ва солро интихоб мекунад.
2. Система рӯйхати менторҳои фаъолро меёбад ва барои ҳар кадом, агар барои он моҳ/сол сабти `Salary` вуҷуд надошта бошад, хароҷот месозад.
3. Ин сабтҳо дар хароҷоти моҳона пайдо мешаванд ва ба ҳисоботи Net Profit таъсир мекунанд.

### Чӣ гуна аз фронтенд истифода мешавад?
- `POST /api/finance/centers/{centerId}/payroll?year=&month=` — бармегардонад шумораи сабтҳои тавлидшуда.


---

## 6) Агрегатсияи моҳона (автоматӣ)

### Барои чӣ лозим аст?
Ҳар моҳ система худкор ҷамъбасти моҳонаро ба ҷадвали `MonthlyFinancialSummary` сабт мекунад (income/expense/net), то дидан ва муқоиса осон шавад.

### Чӣ тавр кор мекунад (сенария)
1. Хизмат (BackgroundService) ҳар моҳ пас аз оғози моҳи нав ба кор медарояд.
2. Барои ҳар марказ даромад/хароҷоти моҳанаро ҷамъ карда, сабти `MonthlyFinancialSummary`-ро эҷод/нав мекунад.
3. Истифодабаранда метавонад ҳисоботҳои моҳонаро зуд бинад.


---

## 7) Ядрои мантиқ: чӣ тавр ҳисоб мешавад

- Даромад танҳо аз пардохтҳое аст, ки **Status = Completed/Paid** доранд.
- Хароҷот танҳо аз сабтҳое аст, ки **IsDeleted = false**.
- Қарздорӣ = `Нархи курс (моҳона)` − `Тахфиф` − `Суммаи пардохтҳои воқеӣ барои ҳамон моҳ/сол`.
- `ReceiptNumber` автоматӣ ва ягона дар доираи марказ+моҳ+сол тавлид мешавад (шакли `CTR-{CenterId}-{YYYY}{MM}-{Seq}`), барои пайгирӣ ва чоп.


---

## 8) Мисоли кор (сенарияи аз оғоз то ҳисобот)

1) Менҷер гурӯҳи нави «Python-101»-ро оғоз мекунад; арзиши моҳона 600 сомонӣ.
2) Донишҷӯ Али дар гурӯҳ сабт мешавад; ба ӯ 100 сомонӣ тахфиф дода шуд.
3) Дар оғози моҳ Али меояд ва 500 сомонӣ нақдӣ месупорад:
   - Оператор `POST /api/payments` иҷро мекунад → системa `ReceiptNumber` месозад.
   - Квитансия дар `GET /api/payments/{id}/receipt` дастрас аст.
4) Бо гузашти моҳ, менҷер `GET /finance/.../debts?month=...`-ро мекушояд:
   - Агар Али ҳанӯз қарздор бошад, нишон дода мешавад; дар мисол, 0 сомонӣ (600−100−500=0).
5) Барои ҳама менторҳо `POST /finance/.../payroll` иҷро мешавад → хароҷоти маош барои моҳ тавлид мегардад.
6) Дар «Monthly summary» менҷер мебинад: `Income` аз пардохтҳо, `Expense` аз хароҷот (аз ҷумла Salary), `NetProfit = Income−Expense`.


---

## 9) Саволу ҷавобҳои маъмул

- Агар пардохт ғайринақдӣ бошад, чӣ кор кунам?
  - `paymentMethod`-ро мувофиқ гузоред ва `transactionId`-ро пур кунед. Барои ҳисоботҳо фарқе надорад, вале барои риёлкатсия муфид аст.

- Чаро пардохти ман дар даромадҳо намоиш нест?
  - Боварӣ ҳосил кунед, ки `Status` = `Completed` ё `Paid` аст. `Pending` ба даромад намедарояд.

- Қарздоронро аз рӯи донишҷӯ ҷустуҷӯ карда метавонам?
  - Бале, параметри `studentId` дар `GET debts` мавҷуд аст.

- Кай ҳисоботи моҳона нав мешавад?
  - Хидмати заминавӣ худкор дар оғози моҳи нав (барои моҳи гузашта) якбора ҷамъбаст мекунад.


---

## 10) Чӣ чизҳо баъдтар метавонанд илова шаванд

- Баргардонии пардохт (Refund/Reversal) бо пайгирии робита.
- Бастани моҳ (IsClosed) ва манъи таҳрири маълумот пас аз бастан.
- Файлҳои воқеии квитансия (HTML/PDF) бо шаблон ва боргирӣ аз `wwwroot`.
- Импорт/риёлкатсияи стейтменти бонк.
- Огоҳсозиҳои SMS/Telegram барои қарздорон.


